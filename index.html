<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Hand Detection</title>

  <!-- Preload fonts -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" as="style"
    onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" as="style"
    onload="this.onload=null;this.rel='stylesheet'">

  <!-- Include Socket.IO client library -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <script src="https://js.stripe.com/v3/"></script>



  <style>
    body {
      margin: 0;
      font-family: Poppins, Montserrat, Arial, sans-serif;
      display: flex;
      justify-content: center;
      height: 100vh;
      background-color: #f9f9f9;
      transition: background-color 0.5s;
    }

    #app-container {
      width: 640px;
      text-align: center;
      gap: 20px;
    }

    img {
      border: 2px solid black;
      width: 600px;
      height: 450px;
      background-color: black;
      border-radius: 30px;
      box-shadow: 10px 10px 15px rgba(0, 0, 0, 0.4);
    }

    .slider-container {
      border: 2px solid black;
      border-radius: 30px;
      gap: 10px;
      font-family: 'Inter', Arial, sans-serif;
      margin: 20px;
      box-shadow: 10px 10px 15px rgba(0, 0, 0, 0.4);
      background-color: white;
    }

    .slider {
      width: 300px;
      height: 8px;
      border-radius: 5px;
      outline: none;
      border: none;
      cursor: pointer;
      margin: 10px;
    }

    .slider-value,
    label {
      font-weight: 700;
      font-size: 1rem;
    }

    #donate-button {
      background-color: rgb(0, 0, 0);
      width: 600px;
      height: 80px;
      border-color: transparent;
      font-size: 25px;
      color: white;
    }

    #donate-button:hover {
      background-color: #ffffff;
      color: black;
      box-shadow: 10px 10px 25px rgba(0, 0, 0, 0.6);
      cursor: pointer;
    }

    #donate-button:active {
      background-color: rgb(179, 179, 179);
      color: black;
      cursor: pointer;
    }



    a {
      color: black;
    }
  </style>
</head>

<body>
  <div id="app-container">
    <div>
      <h1 style="margin-bottom: 0;">Hand Detection App</h1>
      <p style="margin-top: 0;">Click anywhere on the screen to let the program beep at you</p>
    </div>
    <img src="/video_feed" alt="Video Feed">

    <div class="slider-container">
      <label for="volume-slider">Volume</label>
      <input class="slider" type="range" id="volume-slider" min="0" max="100" value="50">
      <span class="slider-value" id="volume-value">50%</span>
    </div>

    <div class="slider-container">
      <label for="pitch-slider">Pitch Frequency</label>
      <input class="slider" type="range" id="pitch-slider" min="100" max="2500" value="440">
      <span class="slider-value" id="pitch-value">440 Hz</span>
    </div>

    <button class="slider-container slider-value" id="donate-button">Help Us Help You<br>Donate to Keep Us
      Running!</button>

    <div> <a href="https://github.com/JaredTweed" style="margin-top: 0;">github.com/JaredTweed</a>
      - <a href="https://www.linkedin.com/in/jared-tweed/" style="margin-top: 0;">linkedin.com/in/jared-tweed/</a></div>
  </div>

  <script>
    document.getElementById('donate-button').addEventListener('click', async () => {
      const response = await fetch('/create-checkout-session', { method: 'POST' });
      const session = await response.json();

      if (session.error) {
        alert(session.error);
        return;
      }

      stripe.redirectToCheckout({ sessionId: session.id });
    });
  </script>

  <script>
    // Select the slider and volume display
    const volumeSlider = document.getElementById('volume-slider');
    const volumeValue = document.getElementById('volume-value');
    const pitchSlider = document.getElementById('pitch-slider');
    const pitchValue = document.getElementById('pitch-value');
    volumeSlider.addEventListener('input', () => {
      volumeValue.textContent = `${volumeSlider.value}%`;
      updateVolume();
    });
    pitchSlider.addEventListener('input', () => {
      pitchValue.textContent = `${pitchSlider.value} Hz`;
    });

    // Increment most recent slider with arrows
    let activeSlider = null;
    document.querySelectorAll('.slider').forEach(slider => {
      slider.addEventListener('focus', () => {
        activeSlider = slider;
      });
      slider.addEventListener('blur', () => {
        activeSlider = null;
      });
    });
    document.addEventListener('keydown', (event) => {
      if (!activeSlider) return; // No active slider to adjust
      const step = activeSlider.step ? parseFloat(activeSlider.step) : 1; // Get step value, default is 1
      let newValue = parseFloat(activeSlider.value);
      if (event.key === 'ArrowUp' || event.key === 'ArrowRight') {
        newValue = Math.min(newValue + step, parseFloat(activeSlider.max));
      } else if (event.key === 'ArrowDown' || event.key === 'ArrowLeft') {
        newValue = Math.max(newValue - step, parseFloat(activeSlider.min));
      }
      activeSlider.value = newValue;
      updateSliderValue(activeSlider);
    });
    function updateSliderValue(slider) {
      if (slider.id === 'volume-slider') {
        volumeValue.textContent = `${slider.value}%`;
      } else if (slider.id === 'pitch-slider') {
        pitchValue.textContent = `${slider.value} Hz`;
      }
    }

    // Establish WebSocket connection
    const socket = io();
    socket.on('connect', () => {
      console.log('WebSocket connection established');
    });
    socket.on('disconnect', () => {
      console.log('WebSocket disconnected');
    });

    // Create a shared AudioContext for all beeping
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let currentOscillator = null; // Track the current oscillator
    let currentGainNode = null;
    let beepInterval = null; // Track the interval for pulsing beeps

    // Function to play a beep sound
    function playBeep() {
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.type = 'sine'; // Options: 'sine', 'square', 'sawtooth', 'triangle'
      oscillator.frequency.setValueAtTime(pitchSlider.value, audioContext.currentTime);
      gainNode.gain.setValueAtTime(volumeSlider.value / 100, audioContext.currentTime); // Scale volume 0 to 1
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.start();
      currentOscillator = oscillator;
      currentGainNode = gainNode;
      return oscillator;
    }

    // Function to stop the beep sound
    function stopBeep(oscillator) {
      if (oscillator) {
        try {
          oscillator.stop(); // Stop the oscillator
          oscillator.disconnect(); // Disconnect it from the destination
        } catch (e) {
          console.warn('Attempted to stop an already stopped oscillator:', e);
        }
      }
      currentOscillator = null;
      currentGainNode = null;
    }

    function updateVolume() {
      if (currentGainNode) {
        currentGainNode.gain.setValueAtTime(volumeSlider.value / 100, audioContext.currentTime); // Update gain
      }
    }

    // Function to start pulsing beeps
    function startPulsingBeep(pulseInterval = 300) {
      if (beepInterval) return; // Prevent multiple intervals

      beepInterval = setInterval(() => {
        if (currentOscillator) {
          stopBeep(currentOscillator);
        } else {
          playBeep();
        }
      }, pulseInterval); // 500ms pulse interval
    }

    // Function to stop pulsing beeps
    function stopPulsingBeep() {
      clearInterval(beepInterval);
      beepInterval = null;

      if (currentOscillator) {
        stopBeep(currentOscillator);
      }
    }

    // Listen for hand detection events
    socket.on('hand_status', (data) => {
      console.log('Received hand_status event:', data);

      if (data.hand_detected) {
        document.body.style.backgroundColor = 'red';
        startPulsingBeep(); // Start the pulsing beep
      } else {
        document.body.style.backgroundColor = '#f9f9f9';
        stopPulsingBeep(); // Stop the pulsing beep
      }
    });

  </script>
</body>

</html>

<!-- http://127.0.0.1:5000/ -->